
專案名稱：有聲書/小說播放器 (Audiobook Player)
之後的(回復、文件、計畫、專案結構及相關文件)，都用繁體中文描述。
## 1. 專案概述
本專案旨在開發一個專為長篇有聲書或小說設計的音頻播放器，優化大檔案處理能力，並提供精確的時間快進/快退功能與穩定的背景播放體驗。

## 2. 硬體與系統環境
* **作業系統**：Android 6.0 (API Level 23) 或以上。
* **格式支援**：支援常見音軌格式（MP3, AAC, M4A, FLAC, WAV 等）。
* **性能要求**：必須流暢處理體積大於 1GB 的單一音訊檔案，確保尋址 (Seeking) 不卡頓。

---

## 3. 核心功能需求

### 3.1 媒體播放與文件管理
* **媒體引擎 (ExoPlayer/Media3)**：使用 Foreground Service 確保背景播放，並於通知欄提供控制項。
* **文件讀取方式**：支援「資料夾掃描」，自動載入指定路徑下的所有音訊檔案。
* **續播功能 (Resume Playback)**：
    * 毫秒級保存每首音訊的播放進度。
    * 儲存時機：暫停、切換曲目、App 正常或異常關閉時。
* **檔案異動處理**：若紀錄中的檔案已被刪除或路徑變更，系統應「同步刪除」該筆進度紀錄，避免播放失敗。

### 3.2 播放控制介面 (UI/UX)
* **基本控制**：
    * 播放/暫停按鈕（中央主要按鈕）
    * 進度條 (SeekBar) 支援拖曳跳轉
    * 上一首/下一首按鈕（位於播放按鈕兩側）
        * 支援播放清單循環播放
        * 自動從資料庫載入所有音訊檔案建立播放清單
        * 若在第一首按「上一首」會跳到最後一首
        * 若在最後一首按「下一首」會跳到第一首
* **自定義快進/快退**：四個獨立圖示按鈕（+1m, +30s, - 30s, -1m）。
* **鎖定模式 (Lock Mode)**：
    * 開啟後禁用「上一首」、「下一首」、進度條拖曳及快進/快退按鈕，防止誤觸。
    * **極簡 UI**：進入鎖定時自動切換為「黑白高對比模式」，減少螢幕能耗並強化防誤觸體驗。
    * 鎖定時按鈕顯示為半透明（30% 不透明度）以視覺化表示停用狀態。
* **進階調整**：播放速度調整 (0.5x - 2.0x)、睡眠計時器（支援 30秒、1分、5分、10分、15分、30分、45分、60分等多種選項）。
* **外設控制**：支援耳機線控（播放/暫停）與藍牙 AVRCP（顯示歌名於車機、支援藍牙按鍵操作）。

### 3.3 系統整合
* **音訊焦點 (Audio Focus)**：
    * 通話時自動暫停。
    * 其他 App 發聲（如導航）時，可設定為「短暫降低音量 (Duck)」或暫停播放。
* **深色模式**：完整支援系統級 Dark Mode。

---

## 4. 界面與操作規格表格

| 功能 | 說明 | UI 表現 |
| :--- | :--- | :--- |
| **快速跳轉** | 4 個實體圖示按鈕 | 分別對應 -1m, -30s, +30s, +1m |
| **曲目切換** | 上一首/下一首按鈕 | 位於播放按鈕兩側，支援循環播放 |
| **播放進度** | 進度條 (SeekBar) | 精確顯示超大檔案時間與總時長 |
| **鎖定模式** | 切換開關 (Toggle) | 鎖定時按鈕置灰（30% 不透明度），UI 轉為黑白主題 |
| **通知欄** | MediaStyle 通知 | 包含播放/暫停、也加上 -1m, -30s, +30s, +1m 這四個快進/快退按鈕 |

---

## 5. 技术實現要點 (Technical Notes)

### 5.1 超大檔案處理
* 使用 ExoPlayer 的流式讀取機制，避免一次性加載導致記憶體崩潰 (OOM)。

### 5.2 資料持久化
* 使用 Room Database 儲存 `File Path`、`Last Position`、`Duration` 等欄位。

### 5.3 播放清單管理
* 使用延遲載入（Lazy Loading）策略，在首次使用上一首/下一首功能時才從資料庫載入播放清單。
* 使用 Flow.first() 而非持續監聽，避免在 ViewModel 初始化時執行資料庫查詢造成崩潰。
* 播放清單按檔名排序（ASC），提供一致的播放順序。
* 支援循環播放：播放到最後一首時，下一首會回到第一首；在第一首時按上一首會跳到最後一首。

### 5.4 Android 權限與儲存空間適配 (Scoped Storage)
* **Android 10 (API 29) 以下**：申請 `READ_EXTERNAL_STORAGE`。
* **Android 10+ (Scoped Storage)**：
    * 推薦使用 `Storage Access Framework (SAF)` 讓使用者選取資料夾。
    * 獲得資料夾授權後，App 即可在該範圍內進行文件讀取與掃描，不需申請全域存儲權限。
* **Android 13+**：需申請 `READ_MEDIA_AUDIO` 以符合最新的媒體權限規範。

## 以下非需求 ######################


預計專案結構
com.example.novel_r/
├── data/
│   ├── local/          # Room DB, DAOs, Entities
│   └── repository/     # 檔案掃描、進度管理邏輯
├── service/
│   └── PlayerService.kt # Media3 Foreground Service
├── ui/
│   ├── theme/          # 包含黑白鎖定模式的主題定義
│   ├── components/     # 控制按鈕、進度條
│   └── screen/         # 主播放器、檔案列表
└── util/               # 格式化時間、檔案解析工具


請執行 implementation_plan.md